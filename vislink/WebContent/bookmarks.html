<html>
<head>
    <title>Visual Links Bookmarks</title>
    
    <style type="text/css">
    body {
    	font-size: 11px;
		color: 	#808080;
		margin-top: 0px;
		margin-bottom: 3px;
		font-family:"Verdana", "Arial", sans-serif;
    }
    
	h1 {
		font-size: 20px;
		color: 	#808080;
		font-weight: bold;
		margin-top: 0px;
		margin-bottom: 3px;
		font-family:"Verdana", "Arial", sans-serif;
	} 

input {
	border-width: 1px 1px 1px 1px;
	border-spacing: 2px;
	border-style: solid solid solid solid;
	border-color: gray gray gray gray;
	border-collapse: collapse;
	width: 190px; 
}

button {
	border-width: 1px 1px 1px 1px;
	border-spacing: 2px;
	border-style: solid solid solid solid;
	border-color: gray gray gray gray;
	border-collapse: collapse;
	background-color: 	#F0F0F0 ;
	width: 100px; 
}
</style>
    
</head>

<body onload="startBookmarks()">

<script type="text/javascript">

var stopped = true;

//------------- LOADING / UNLOADING -------------

function startBookmarks(){
	stopped = false; 
	
	if (register()) {
		
		window.addEventListener('unload', stopBookmarks, false);
		window.addEventListener('scroll', reportWindowChange, false);
		window.addEventListener('resize', resize, false);
		setTimeout("triggerSearch()", 500);
	}
	window.lastPointerID = null; 
	window.itemColorR = 130; 
	window.itemColorG = 130; 
	window.itemColorB = 130; 
	
	// TODO: remove / add (3 lines)
	//window.lastPointerID = "pointer1"; 
	//setInputId("pointer1", "pointerTestSelection1"); 
	//setInputId("pointer2", "pointerTestSelection2"); 
}

function stopBookmarks() {
	//TODO: re-comment in (1 line) 
	stopped = true;
	window.removeEventListener('unload', stopBookmarks, false);
	window.removeEventListener('scroll', clearVisualLinks, false);
	unregister();
}

function register() {
	if (window.visLinkAppName == null) {
		window.visLinkAppName =	"bookmarks-" + (new Date()).getTime();
	}

	var win = content.document.defaultView;
	var x = win.screenX + (win.outerWidth - win.innerWidth) / 2;
	var y = win.screenY + (win.outerHeight - win.innerHeight);
	var w = win.innerWidth;
	var h = win.innerHeight;

	var	xml	= "";
	xml	+= "<boundingBox";
	xml	+= " x=\""+x+"\"";
	xml	+= " y=\""+y+"\"";
	xml	+= " width=\""+w+"\"";
	xml	+= " height=\""+h+"\"";
	xml	+= " />\n";

	xml	= escape(xml);

	var	requrl = "http://localhost:8080/visdaemon/register";
	requrl += "?name=" + window.visLinkAppName;
	requrl += "&xml=" +	xml;

	//alert("register"); 
	
	try {
		var	xhttp =	new	XMLHttpRequest();
		xhttp.open("GET", requrl, false);
		xhttp.send("");
		xmlDoc = xhttp.responseXML;
	} catch (err) {
		alert("Could not establish connection to visdaemon.");
		// TODO: re-comment in (2 lines) 
		stopped = true;
		return false;
	}
	return true;
}

function unregister() {
	var	requrl = "http://localhost:8080/visdaemon/unregister";
	requrl += "?name=" + window.visLinkAppName;

	alert("unregister"); 
	
	try {
		var	xhttp =	new	XMLHttpRequest();
		xhttp.open("GET", requrl, false);
		xhttp.send("");
		xmlDoc = xhttp.responseXML;
	} catch (err) {
		// vis link server no reachable, nothing to do
	}
}

function resize() {
	reportWindowChange();
}

//------------- SELECTION POLLING -------------

// timeout callback function: request current user selection 
function triggerSearch() {
	validateWindowPosition();
	if (stopped) return;
	
	// TODO: get(Test)Id(); 
	var	id = getId();
	//debugOutput("ID: "+id); 
	
	if (stopped) return; // second check, because getId() might have lost connection to daemon
	
	// if a button with the given selection ID was found 
	if (id != null)	{
		//debugOutput("---"); 
		// in any case, write the current selection into the input field 
		//setInputField(id); 
		setInputId(window.lastPointerID, id); 
		
		// generate bounding boxes
		var	bb	= getButtonBB(id);
		var	xml	= generateBoundingBoxesXML(bb,	false);
		sendBoundingBoxes(xml);
		
	}
	
	if (stopped) return; 
	
	//var bookmark = fetchBookmark(); 
	//if (stopped) return; 
	//if (bookmark != null) {
	//	createButton(bookmark); 
	//}
	
	setTimeout("triggerSearch()", 200);
}

//------------- RECEIVING FROM VIS DAEMON -------------

function getTestId() {
	stopped = false; 
 	return "TestSelection"; 
}

// polling for selection ID 
function getId() {
	var	requrl = "http://localhost:8080/visdaemon/propagation";
	requrl += "?name=" + window.visLinkAppName;
	
	//alert(requrl); 

	try {
		var	xhttp =	new	XMLHttpRequest();
		xhttp.open("GET", requrl, false);
		xhttp.send("");
		xmlDoc = xhttp.responseXML;
	} catch (err) {
		// TODO: re-comment in (2 lines) 
		alert("Connection to visdaemon lost, stopping");
		stopBookmarks();
		return null;
	}

	var pointers = xmlDoc.getElementsByTagName("pointer"); 
	var	ids	= xmlDoc.getElementsByTagName("id");
	if(pointers.length > 0){
		if(pointers[0].childNodes[0] != null){
			window.lastPointerID = pointers[0].childNodes[0].nodeValue; 
		}
	}
	if (ids.length > 0)	{
		if (ids[0].childNodes[0] !=	null) {
			return ids[0].childNodes[0].nodeValue;
		}
	}
	//debugOutput("no id received"); 
	return null;
}


// polling for bookmarks 
/*
function fetchBookmark() {
	var	requrl = "http://localhost:8080/visdaemon/fetchBookmark";
	requrl += "?name=" + window.visLinkAppName;

	try {
		var	xhttp =	new	XMLHttpRequest();
		xhttp.open("GET", requrl, false);
		xhttp.send("");
		xmlDoc = xhttp.responseXML;
	} catch (err) {
		alert("Connection to visdaemon lost, stopping");
		//stopBookmarks();
		return null;
	}

	var pointers = xmlDoc.getElementsByTagName("pointer"); 
	var r = xmlDoc.getElementsByTagName("r"); 
	var g = xmlDoc.getElementsByTagName("g"); 
	var b = xmlDoc.getElementsByTagName("b"); 
	var	ids	= xmlDoc.getElementsByTagName("bookmark");
	if(pointers.length > 0){
		if(pointers[0].childNodes[0] != null){
			window.lastPointerID = pointers[0].childNodes[0].nodeValue; 
		}
	}
	window.itemColorR = r[0].childNodes[0].nodeValue; 
	window.itemColorG = g[0].childNodes[0].nodeValue; 
	window.itemColorB = b[0].childNodes[0].nodeValue; 
	if (ids.length > 0)	{
		if (ids[0].childNodes[0] !=	null) {
			return ids[0].childNodes[0].nodeValue;
		}
	}
	return null;
}
*/

//------------- SENDING TO VIS DAEMON -------------

// visual links are reported whenever an existing button was pressed 
function reportVisLinks(selectionId, bb) {
	var	doc	= content.document;
	var	xml	= generateBoundingBoxesXML(bb,	true);

	var	requrl = "http://localhost:8080/visdaemon/selection";
	requrl += "?name=" + window.visLinkAppName;
	requrl += "&id=" + selectionId;
	requrl += "&xml=" +	xml;
	
	//alert(requrl); 
	//debugOutput(requrl); 

	var	xhttp =	new	XMLHttpRequest();
	xhttp.open("GET", requrl, false);
	xhttp.send("");
	xmlDoc = xhttp.responseXML;
}

// window change is reported on window move, resize, and scroll 
function reportWindowChange() {
	var	requrl = "http://localhost:8080/visdaemon/reportWindowChange";
	requrl += "?name=" + window.visLinkAppName;
	
	//alert(requrl); 
	//debugOutput(requrl); 
	
	var	xhttp =	new	XMLHttpRequest();
	xhttp.open("GET", requrl, false);
	xhttp.send("");
	xmlDoc = xhttp.responseXML;
}

// clear visual links is called on page unload 
function clearVisualLinks()	{
	var	requrl = "http://localhost:8080/visdaemon/clearVisualLinks";
	requrl += "?name=" + window.visLinkAppName;

	try	{
		var	xhttp =	new	XMLHttpRequest();
		xhttp.open("GET", requrl, false);
		xhttp.send("");
		xmlDoc = xhttp.responseXML;
	} catch (err) {
		alert("Connection to visdaemon lost, stopping");
		//TODO: re-comment in (1 line) 
		stopBookmarks();
	}
}

// bounding boxes are sent as response to a visual links request 
function sendBoundingBoxes(xml)	{
	var	requrl = "http://localhost:8080/visdaemon/reportVisualLinks"
	requrl += "?name=" + window.visLinkAppName;
	requrl += "&pointer=" + window.lastPointerID; 
	requrl += "&xml=" +	xml;

	//debugOutput(requrl); 
	
	try	{
		var	xhttp =	new	XMLHttpRequest();
		xhttp.open("GET", requrl, false);
		xhttp.send("");
		xmlDoc = xhttp.responseXML;
	} catch(err) {
	}
}

/*
// a bookmark has to be created whenever a create (custom) bookmark button was pressed 
function sendCreateBookmark(bookmarkName) {
	var	requrl = "http://localhost:8080/visdaemon/bookmark";
	requrl += "?name=" + window.visLinkAppName;
	requrl += "&bookmark=" + bookmarkName; 
	requrl += "&action=create"; 
	
	//alert(requrl); 
	try	{
		var	xhttp =	new	XMLHttpRequest();
		xhttp.open("GET", requrl, false);
		xhttp.send("");
		xmlDoc = xhttp.responseXML;
	} catch(err) {
	}
}


// a bookmark has to be deleted when the x button has been pressed 
function sendRemoveBookmark(bookmarkName) {
	var	requrl = "http://localhost:8080/visdaemon/bookmark";
	requrl += "?name=" + window.visLinkAppName;
	requrl += "&bookmark=" + bookmarkName; 
	requrl += "&action=remove"; 
	
	//alert(requrl); 
	
	var	xhttp =	new	XMLHttpRequest();
	xhttp.open("GET", requrl, false);
	xhttp.send("");
	xmlDoc = xhttp.responseXML;
}
*/

//------------- WINDOW OPERATIONS -------------

function validateWindowPosition() {
	var oldPos = window.oldPos;
	if (oldPos != null) {
		if (window.screenX != oldPos.x || window.screenY != oldPos.y) {
			register();
			oldPos.x = window.screenX;
			oldPos.y = window.screenY;
			reportWindowChange();
		}
	} else {
		window.oldPos = new Object();
		window.oldPos.x = window.screenX;
		window.oldPos.y = window.screenY;
	}
}

//------------- BOUNDING BOXES -------------

function findBoundingBox(obj) {
	var	w =	obj.offsetWidth;
	var	h =	obj.offsetHeight;
	var	curleft	= curtop = 0;

	if (obj.offsetParent) {
		do {
			curleft	+= obj.offsetLeft;
			curtop += obj.offsetTop;
		} while	(obj = obj.offsetParent);
	}

	var	body = document.getElementsByTagName("body")[0];
	var	win	= body.ownerDocument.defaultView;
	var	yoffset	= win.outerHeight -	win.innerHeight + 1;

	var	ret	= null;
	
		finaltop = curtop + win.screenY + yoffset - win.pageYOffset;
		finalleft = curleft + win.screenX + 1 - win.pageXOffset;
		
		ret	= new Object();
		ret.x =	finalleft;
		ret.y =	finaltop;
		ret.width =	w +	2;
		ret.height = h + 1;
		
		//debugOutput("Bounding box: " + ret.x + ", " + ret.y + "  [" + ret.width + " x " + ret.height + "]"); 
		
	return ret;
}

function generateBoundingBoxesXML(bb, source) {
	var	xml	= "<boundingBoxList>";
	if(bb != null){
		xml	+= "<boundingBox";
		xml	+= " x=\""+bb.x+"\"";
		xml	+= " y=\""+bb.y+"\"";
		xml	+= " width=\""+bb.width+"\"";
		xml	+= " height=\""+bb.height+"\"";
		xml	+= " source=\""+source+"\"";
		xml	+= " />\n";
		source = false;
	}
	xml	+= "</boundingBoxList>\n";

	xml	= escape(xml);
	
	return xml;
}

function getButtonBB(buttonName) {	
	var button = document.getElementById(buttonName); 
	
	var bb = null; 
	if(button != null){
		bb = findBoundingBox(button); 
	}
	else{
		//debugOutput(buttonName + " not found"); 
	}
	return bb; 
}

//------------- BUTTONS -------------

function removeButton(buttonName){
	var message = "Delete bookmark: "; 
	message += buttonName; 
	message += "?"; 
	var result = confirm(message); 
	
	if(result == true){
	
		var region = document.getElementById("receivedButton"); 
		var paragraph = document.getElementById(buttonName+"-p"); 
		var buttonField = document.getElementById(buttonName); 
		var deleteButtonField = document.getElementById(buttonName+"-del"); 
		
		//debugOutput("Remove button "+buttonName); 
	
		paragraph.removeChild(buttonField); 
		paragraph.removeChild(deleteButtonField); 
		region.removeChild(paragraph); 
	
		//sendRemoveBookmark(buttonName); 
	}
}

function pressedButton(buttonName) {
	var bb = getButtonBB(buttonName); 
	reportVisLinks(buttonName, bb); 
	setInputId(window.lastPointerID, buttonName); 
}




function createTestButton() {
	var buttonField = document.getElementById("entryButton");
	var buttonName = buttonField.value;
	if (buttonName != null && buttonName.length > 0) {
		 
		var paragraph = document.createElement("p"); 
		paragraph.id = buttonName+"-p"; 
		
		var linkButton = document.createElement("input"); 
		linkButton.id = buttonName; 
		linkButton.value = buttonName; 
		linkButton.type = "button"; 
		linkButton.style.backgroundColor = RGB2SoftHTML(window.itemColorR, window.itemColorG, window.itemColorB); 
		linkButton.class = "frame"; 
		linkButton.onclick = function(){pressedButton(buttonName)}; 
		
		var spaceNode = document.createTextNode(' '); 
		
		var deleteButton = document.createElement("input"); 
		deleteButton.id = buttonName+"-del"; 
		deleteButton.value = "X"; 
		deleteButton.type = "button"; 
		deleteButton.style.backgroundColor = "#ffffff"; 
		deleteButton.class = "frame"; 
		deleteButton.style.backgroundColor = "#F8F8F8 "; 
		deleteButton.style.width = "25"; 
		deleteButton.onclick = function(){removeButton(buttonName)}; 

		paragraph.appendChild(linkButton); 
		paragraph.appendChild(spaceNode); 
		paragraph.appendChild(deleteButton); 
		document.getElementById("receivedButton").appendChild(paragraph); 
	} else {
		alert("buttonName empty");
	}
}

function createButton(bookmarkName){
	if(bookmarkName != null && bookmarkName.length > 0) {
	
		var existing = document.getElementById(bookmarkName);
		if(existing != null){
			alert(existing.value + " already bookmarked"); 
			return; 
		}
		
		var paragraph = document.createElement("p"); 
		paragraph.id = bookmarkName+"-p"; 
		
		var linkButton = document.createElement("input"); 
		linkButton.id = bookmarkName; 
		linkButton.value = bookmarkName; 
		linkButton.type = "button"; 
		linkButton.style.backgroundColor = RGB2SoftHTML(window.itemColorR, window.itemColorG, window.itemColorB); 
		linkButton.class = "frame"; 
		linkButton.onclick = function(){pressedButton(bookmarkName)}; 
		
		var spaceNode = document.createTextNode(' '); 
		
		var deleteButton = document.createElement("input"); 
		deleteButton.id = bookmarkName+"-del"; 
		deleteButton.value = "X"; 
		deleteButton.type = "button"; 
		deleteButton.style.backgroundColor = "#ffffff"; 
		deleteButton.class = "frame"; 
		deleteButton.style.backgroundColor = "#F0F0F0"; 
		deleteButton.style.width = "25"; 
		deleteButton.onclick = function(){removeButton(bookmarkName)}; 

		paragraph.appendChild(linkButton); 
		paragraph.appendChild(spaceNode); 
		paragraph.appendChild(deleteButton); 
		document.getElementById("receivedButton").appendChild(paragraph);

		// when a button is added, the location of linked buttons might change
		reportWindowChange();  
	}
	else{
		alert("Cannot create empty bookmark"); 
	}
}

//------------- COLORS -------------

function toHex(N) {
 if (N==null) return "00";
 N=parseInt(N); if (N==0 || isNaN(N)) return "00";
 N=Math.max(0,N); N=Math.min(N,255); N=Math.round(N);
 return "0123456789ABCDEF".charAt((N-N%16)/16)
      + "0123456789ABCDEF".charAt(N%16);
}

function RGB2HTML(R, G, B)
{return toHex(R)+toHex(G)+toHex(B)}

function RGB2SoftHTML(R, G, B)
{
	R += 120; 
	G += 120; 
	B += 120; 
	return RGB2HTML(R, G, B); 
}

//------------- INPUT FIELD -------------


function setInputField(value) {
	var buttonField = document.getElementById("entryButton");
	if(buttonField != null){
		buttonField.value = value; 
	}
}

function setInputId(pointer, id){
	if(pointer != null){
		var pointerInput = document.getElementById(pointer); 
		if(pointerInput == null){
			createInputField(pointer, id); 
		}
		else{
			pointerInput.value = id; 
		}
	}
	else{
		//debugOutput("Pointer is null"); 
	}
}

function createInputField(pointer, id){
	var paragraph = document.createElement("p"); 
	paragraph.id = pointer+"-p"; 
		
	var inputField = document.createElement("input"); 
	inputField.id = pointer; 
	inputField.value = id; 
	inputField.type = "Text"; 
	inputField.style.backgroundColor = "#ffffff"; 	
	inputField.class = "frame"; 
		
	var spaceNode = document.createTextNode(' '); 
		
	var button = document.createElement("input"); 
	button.id = pointer + "button"; 
	button.value = "bookmark"; 
	button.type = "button"; 
	button.class = "frame"; 
	button.style.backgroundColor = "#F0F0F0"; 
	button.style.width = "100"; 
	button.onclick = function(){createBookmark(pointer)}; 
	
	var pointerNode = document.createTextNode(" ["+pointer+"]"); 

	paragraph.appendChild(inputField); 
	paragraph.appendChild(spaceNode); 
	paragraph.appendChild(button); 
	paragraph.appendChild(pointerNode); 
	document.getElementById("inputFields").appendChild(paragraph);
}

function debugOutput(output) {
	var debug = document.getElementById("debug"); 
	if(debug != null){
		debug.innerHTML = output; 
	}
}

//------------- BOOKMARKS -------------

/*
function createBookmark(){
	sendCreateBookmark(""); 
}
*/

function createBookmark(entryButton){
	//alert("create bookmark from: " + entryButton); 
	if(entryButton != null){
		var buttonField = document.getElementById(entryButton);
		var buttonName = buttonField.value;
		if (buttonName != null && buttonName.length > 0) {
			//sendCreateBookmark(buttonName); 
			createButton(buttonName); 
		}
		else{
			alert("Cannot create empty bookmark"); 
		}
	}
	else{
		alert("invalid source button"); 
	}
}

</script>


<h1> Visual Links Bookmarks </h1>

<p><input id="entryButton" type="Text" value=""/> <button class="frame" onclick="createBookmark('entryButton')">bookmark</button></p>

<span id="inputFields"></span>

<!-- <p><button class="frame" onclick="createBookmark()">create bookmark</button></p> -->

&nbsp; 

<span id="receivedButton"></span>

&nbsp; 

<span id="debug"></span>

</body>

</html>    

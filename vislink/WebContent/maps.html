<html><head>
    <title>Google Maps</title>
</head>
<body>

<!-- You can use things like divs and tables to position your map wherever you want it within your page -->
<center>
  <div id="mapsearch">
    <span style="color:#676767;font-size:11px;margin:10px;padding:4px;">Loading...</span>
  </div>
</center>

  <script src="http://maps.google.com/maps?file=api&v=2&amp;sensor=false&key=ABQIAAAAS3_IfYCkXPfhdPOAJAQtqBQiwqvF03-joXVPTwe3Qkq_-BUC3hTb_YsT2U2IWBGUa2lsmaxNUmC1Hg" type="text/javascript"></script>
  <script src="http://www.google.com/uds/api?file=uds.js&v=1.0&amp;sensor=false&key=ABQIAAAAS3_IfYCkXPfhdPOAJAQtqBQiwqvF03-joXVPTwe3Qkq_-BUC3hTb_YsT2U2IWBGUa2lsmaxNUmC1Hg" type="text/javascript"></script>
  <link href="http://www.google.com/uds/css/gsearch.css" rel="stylesheet" type="text/css"/>

  <!-- Map Search Control and Stylesheet -->
  <script src="http://www.google.com/uds/solutions/mapsearch/gsmapsearch.js" type="text/javascript"></script>
  <link href="http://www.google.com/uds/solutions/mapsearch/gsmapsearch.css" rel="stylesheet" type="text/css"/>

<script type="text/javascript">
var map;
var geocoder;
GSearch.setOnLoadCallback(LoadMapSearchControl);

function LoadMapSearchControl() {

  var options = {
        size : new GSize(600, 400),
        zoomControl : GSmapSearchControl.ZOOM_CONTROL_ENABLE_ALL,
        title : "Graz",
        idleMapZoom : GSmapSearchControl.ACTIVE_MAP_ZOOM,
        activeMapZoom : GSmapSearchControl.ACTIVE_MAP_ZOOM
        }

/*      new GSmapSearchControl(
        document.getElementById("mapsearch"),
        "FY3 0HH",
        options
        );
*/
    map = new GMap2(document.getElementById("mapsearch"), options);
    map.setCenter(new GLatLng(47.07, 15.45, false), 8);

    geocoder = new GClientGeocoder();
    
   	register();
   	setTimeout("triggerSearch()", 3000);
}

function getScreenCoords(point) {
    var ll = map.fromLatLngToContainerPixel(point);
    var mapdiv = document.getElementById("mapsearch");
    var divpos = findPos(mapdiv);

    var yoffset = window.outerHeight - window.innerHeight;
    pos = new GPoint(divpos.x + ll.x + window.screenX, window.screenY + divpos.y + ll.y + yoffset);
    return pos;
}

function sendBoundingBoxes(pos) {
    var xml = "<boundingBoxList>";
    if (pos != null) {
	    xml += "<boundingBox";
	    xml += " x=\"" + (pos.x - 10) + "\"";
	    xml += " y=\"" + (pos.y - 10) + "\"";
	    xml += " width=\"" + 20 + "\"";
	    xml += " height=\"" + 20 + "\"";
	    xml += " />\n";
    }
    xml += "</boundingBoxList>\n";

    xml = escape(xml);
    var requrl = "http://localhost:8080/visdaemon/reportVisualLinks?name=googlemaps&xml=" + xml;
    
	var xhttp = new XMLHttpRequest();
	xhttp.open("GET", requrl, false);
	xhttp.send("");
	xmlDoc = xhttp.responseXML;
}

function findPos(obj) {
	var curleft = curtop = 0;
    if (obj.offsetParent) {
        do {
            curleft += obj.offsetLeft;
            curtop += obj.offsetTop;
        } while (obj = obj.offsetParent);
    }
    return new GPoint(curleft, curtop);
}

function findAddress(address, callback) {
    if (geocoder) {
        geocoder.getLatLng(address, callback);
    }
}

function vislinkAddressCallback(point) {
	var pos = null;
    if (point == null) {
        alert("address not found");
    } else {
        var pos = getScreenCoords(point);
    }
    sendBoundingBoxes(pos);
}

function setCenter() {
    map.setCenter(new GLatLng(47.07, 15.45, false), 8);
}

function triggerSearch() {
	var id = getId();
	if (id != null) {
        findAddress(id, vislinkAddressCallback);
    }
	setTimeout("triggerSearch()", 3000);
}

function getId() {
	var xhttp = new XMLHttpRequest();
	xhttp.open("GET", "http://localhost:8080/visdaemon/propagation?name=googlemaps", false);
	xhttp.send("");
	xmlDoc = xhttp.responseXML;
	var ids = xmlDoc.getElementsByTagName("id");
	if (ids.length > 0) {
		return ids[0].childNodes[0].nodeValue;
	} else {
		return null;
	}
}

function register() {
	var x = window.screenX;
	var y = window.screenY;
	var w = window.outerWidth;
	var h = window.outerHeight;

	var xml = "";
    xml += "<boundingBox";
    xml += " x=\""+x+"\"";
    xml += " y=\""+y+"\"";
    xml += " width=\""+w+"\"";
    xml += " height=\""+h+"\"";
    xml += " />\n";

    xml = escape(xml);

	try {
		var xhttp = new XMLHttpRequest();
		xhttp.open("GET", "http://localhost:8080/visdaemon/register?name=googlemaps&xml=" + xml, false);
		xhttp.send("");
		xmlDoc = xhttp.responseXML;
	} catch (err) {
		alert("unexpected error: err");
	}
}

function addressLookup() {
	var addressField = document.getElementById("address");
	var address = addressField.value;
	if (address != null && address.length > 0) {
		findAddress(address, lookupCallback);
	} else {
		alert("address empty");
	}
}

function lookupCallback(point) {
    var addressField = document.getElementById("address");
	var address = addressField.value;

	if (point == null) {
        alert(address +" not found");
    } else {
        map.setCenter(point);
        var pos = getScreenCoords(point);
        selectVisLink(address);
    }
}

function selectVisLink(id) {
	var xhttp = new XMLHttpRequest();
	xhttp.open("GET", "http://localhost:8080/visdaemon/selection?name=googlemaps&id=" + id, false);
	xhttp.send("");
	xmlDoc = xhttp.responseXML;
}

function debug(s) {
    var d = document.getElementById("debug");
    d.innerHTML += s + "<br />";
}
</script>

<input type="Text" id="address" value="Graz" /><button onclick="addressLookup()">find</button><br />

<a href="javascript:findAddress('Graz')">find graz</a> <a href="javascript:setCenter()">setCenter</a><br />

<div id="coords" />

<div id="debug" />

</body>

</html>            
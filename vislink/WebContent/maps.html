<html>
<head>
    <title>Google Maps</title>
</head>
  <link href="http://www.google.com/uds/css/gsearch.css" rel="stylesheet" type="text/css"/>
  <link href="http://www.google.com/uds/solutions/mapsearch/gsmapsearch.css" rel="stylesheet" type="text/css"/>
<body>

<!-- You can use things like divs and tables to position your map wherever you want it within your page -->
<center>
  <div id="mapsearch">
    <span style="color:#676767;font-size:11px;margin:10px;padding:4px;">Loading...</span>
  </div>
</center>

  <script src="http://maps.google.com/maps?file=api&v=2&amp;sensor=false&key=ABQIAAAAS3_IfYCkXPfhdPOAJAQtqBQiwqvF03-joXVPTwe3Qkq_-BUC3hTb_YsT2U2IWBGUa2lsmaxNUmC1Hg" type="text/javascript"></script>
  <script src="http://www.google.com/uds/api?file=uds.js&v=1.0&amp;sensor=false&key=ABQIAAAAS3_IfYCkXPfhdPOAJAQtqBQiwqvF03-joXVPTwe3Qkq_-BUC3hTb_YsT2U2IWBGUa2lsmaxNUmC1Hg" type="text/javascript"></script>

  <!-- Map Search Control and Stylesheet -->
  <script src="http://www.google.com/uds/solutions/mapsearch/gsmapsearch.js" type="text/javascript"></script>

<script type="text/javascript">
var map;
var geocoder;
var localSelectionId = null;
var remoteScroll = false;

GSearch.setOnLoadCallback(LoadMapSearchControl);

function LoadMapSearchControl() {

	var mapSize = new GSize(window.innerWidth-40, window.innerHeight-80);
	var options = {
        size : mapSize,
        zoomControl : GSmapSearchControl.ZOOM_CONTROL_ENABLE_ALL,
        title : "Graz",
        idleMapZoom : GSmapSearchControl.ACTIVE_MAP_ZOOM,
        activeMapZoom : GSmapSearchControl.ACTIVE_MAP_ZOOM
        }

    map = new GMap2(document.getElementById("mapsearch"), options);
    map.setCenter(new GLatLng(47.07, 15.45, false), 8);

    map.addControl(new GLargeMapControl()); 
    map.addControl(new GMapTypeControl()); 

    GEvent.addListener(map, "moveend", scrollMap);
    geocoder = new GClientGeocoder();
    
   	register();
	window.addEventListener('resize', resize, false);
	setTimeout("triggerSearch()", 1000);
}

function getScreenCoords(point) {
    var ll = map.fromLatLngToContainerPixel(point);
    var mapdiv = document.getElementById("mapsearch");
    var divpos = findPos(mapdiv);

    var yoffset = window.outerHeight - window.innerHeight;
    pos = new GPoint(divpos.x + ll.x + window.screenX, window.screenY + divpos.y + ll.y + yoffset);
    return pos;
}

function generateBoundingBoxXML(pos, source) {
    var xml = "<boundingBoxList>";
    if (pos != null) {
	    xml += "<boundingBox";
	    xml += " x=\"" + (pos.x - 10) + "\"";
	    xml += " y=\"" + (pos.y - 10) + "\"";
	    xml += " width=\"" + 20 + "\"";
	    xml += " height=\"" + 20 + "\"";
	    xml += " source=\"" + source + "\"";
	    xml += " />\n";
    }
    xml += "</boundingBoxList>\n";
    xml = escape(xml);
    return xml;
}

function sendBoundingBoxes(pos) {
    var xml = generateBoundingBoxXML(pos, false);
    var requrl = "http://localhost:8080/visdaemon/reportVisualLinks?name=googlemaps&xml=" + xml;
    
	var xhttp = new XMLHttpRequest();
	xhttp.open("GET", requrl, false);
	xhttp.send("");
	xmlDoc = xhttp.responseXML;
}

function findPos(obj) {
	var curleft = curtop = 0;
    if (obj.offsetParent) {
        do {
            curleft += obj.offsetLeft;
            curtop += obj.offsetTop;
        } while (obj = obj.offsetParent);
    }
    return new GPoint(curleft, curtop);
}

function findAddress(address, callback) {
    if (geocoder) {
// 		geocoder.getLatLng(address, callback);
		geocoder.getLocations(address, callback); 
    }
}

function vislinkAddressCallback(response) {
	var pos = null; 
	if(!response || response.Status.code != 200) {
		alert("address not found"); 
	} else {
		var place = response.Placemark[0]; 
		var point = new GLatLng(place.Point.coordinates[1], place.Point.coordinates[0]); 
		var accuracy = place.AddressDetails.Accuracy; 
        var center = document.getElementById("center").checked;
        if (center) {
			remoteScroll = true;
			map.setCenter(point, Math.round(2 + accuracy * 14/9));
        } 
		pos = getScreenCoords(point); 
	}
	sendBoundingBoxes(pos); 
}

function triggerSearch() {
	validateWindowPosition();
	var id = getId();
	if (id != null) {
		localSelectionId = id;
		document.getElementById("receivedId").innerHTML = id;
        findAddress(id, vislinkAddressCallback);
    }
	setTimeout("triggerSearch()", 200);
}

function getId() {
	var xhttp = new XMLHttpRequest();
	xhttp.open("GET", "http://localhost:8080/visdaemon/propagation?name=googlemaps", false);
	xhttp.send("");
	xmlDoc = xhttp.responseXML;
	var ids = xmlDoc.getElementsByTagName("id");
	if (ids.length > 0) {
		return ids[0].childNodes[0].nodeValue;
	} else {
		return null;
	}
}

function register() {
	
	var x = window.screenX + (window.outerWidth - window.innerWidth) / 2;
	var y = window.screenY + (window.outerHeight - window.innerHeight);
	var w = window.innerWidth;
	var h = window.innerHeight;

	var xml = "";
    xml += "<boundingBox";
    xml += " x=\""+x+"\"";
    xml += " y=\""+y+"\"";
    xml += " width=\""+w+"\"";
    xml += " height=\""+h+"\"";
    xml += " />\n";

    xml = escape(xml);

	try {
		var xhttp = new XMLHttpRequest();
		xhttp.open("GET", "http://localhost:8080/visdaemon/register?name=googlemaps&xml=" + xml, false);
		xhttp.send("");
		xmlDoc = xhttp.responseXML;
	} catch (err) {
		alert("unexpected error: err");
	}
}

function scrollMap() {
	if (remoteScroll) {
		remoteScroll = false;
		return;
	}
	windowChanged();
}
function windowChanged() {
	if (localSelectionId != null && localSelectionId.length > 0) {
		findAddress(localSelectionId, windowChangedCallback);
	} else {
		// clearVisualLinks();
		findAddress(localSelectionId, windowChangedCallback);
	}
}

function windowChangedCallback(response) {
	if(!response || response.Status.code != 200) {
		alert("address not found"); 
	} else {
		var place = response.Placemark[0]; 
		var accuracy = place.AddressDetails.Accuracy; 
		var point = new GLatLng(place.Point.coordinates[1], place.Point.coordinates[0]); 
		var pos = getScreenCoords(point); 

		var xml = generateBoundingBoxXML(pos, true);
        sendVisLinkSelection(localSelectionId, xml);
    }
}

function addressLookup() {
	var addressField = document.getElementById("address");
	var address = addressField.value;
	if (address != null && address.length > 0) {
		findAddress(address, lookupCallback);
	} else {
		alert("address empty");
	}
}

function lookupCallback(response) {
    var addressField = document.getElementById("address");
	var address = addressField.value;
	localSelectionId = address;

	if(!response || response.Status.code != 200) {
		alert("address not found"); 
	} else {
		var place = response.Placemark[0]; 
		var accuracy = place.AddressDetails.Accuracy; 
		var point = new GLatLng(place.Point.coordinates[1], place.Point.coordinates[0]); 
        var center = document.getElementById("center").checked;
		remoteScroll = true;
		map.setCenter(point, Math.round(2 + accuracy * 14/9));
		var pos = getScreenCoords(point); 

		var xml = generateBoundingBoxXML(pos, true);
        sendVisLinkSelection(address, xml);
    }
}

function sendVisLinkSelection(id, xml) {
	var requrl = "http://localhost:8080/visdaemon/selection?name=googlemaps";
	requrl += "&id=" + id;
	requrl += "&xml=" + xml;

	var xhttp = new XMLHttpRequest();
	xhttp.open("GET", requrl, false);
	xhttp.send("");
	xmlDoc = xhttp.responseXML;
}

function clearVisualLinks() {
	var	requrl = "http://localhost:8080/visdaemon/clearVisualLinks";
	requrl += "?name=" + window.visLinkAppName;

	var	xhttp =	new	XMLHttpRequest();
	xhttp.open("GET", requrl, false);
	xhttp.send("");
	xmlDoc = xhttp.responseXML;
}

function validateWindowPosition() {
	var currentPos = new GPoint(window.screenX, window.screenY);
	var oldPos = window.oldPos;
	if (oldPos != null) {
		if (currentPos.x != oldPos.x || currentPos.y != oldPos.y) {
			register();
			window.oldPos = currentPos;
			windowChanged();
		}
	} else {
		window.oldPos = currentPos;
	}
}

function resize() {
	var mapDiv = document.getElementById("mapsearch");
	mapDiv.style.width = window.innerWidth-40;
	mapDiv.style.height = window.innerHeight-80;
	map.checkResize();
	register();
	windowChanged();
}

function debug(s) {
    var d = document.getElementById("debug");
    d.innerHTML += s + "<br />";
}
</script>

<table>
<tr>
	<td>
		<input id="address" type="Text" value="Graz" /><button onclick="addressLookup()">find</button>
	</td>
	<td width="20">&nbsp;</td>
	<td>Received Selection:</td>
	<td><span id="receivedId"></span></td>
</tr>
<tr>
	<td>
		<input id="center" type="checkbox" checked="true" /> center map to external selection
	</td>
	<td></td>
	<td></td>
	<td></td>
</tr>
</table>
<div id="debug"></div>

</body>

</html>            